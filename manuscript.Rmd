---
title             : "Full-day, in home validation of infant body position measurements from inertial sensors"
shorttitle        : "Infant position in the home"

author: 
  - name          : "John M. Franchak"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "UC Riverside Department of Psychology, 900 University Avenue, Riverside, CA 92521"
    email         : "franchak@ucr.edu"
  - name          : "Maximilian Tang"
    affiliation   : "1"
  - name          : "Hailey Rousey"
    affiliation   : "1"
  - name          : "Chuan Luo"
    affiliation   : "1"
      
authornote: |
  Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.

  Enter author note here.

abstract: |
  Abstract
  
keywords          : "body position, motor development, everyday experiences, sitting, machine learning"
wordcount         : "X"

bibliography      : "master.bib"

floatsintext      : no
linenumbers       : no
draft             : no
mask              : no
figurelist        : no
tablelist         : no
footnotelist      : no
csl               : apa.csl
classoption       : "man"
output            : papaja::apa6_pdf
header-includes:
  - \raggedbottom
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
library(papaja)
library(knitr)
library(patchwork)
library(scales)
library(ggforce)
library(hms)
library(tidyverse)
library(rstatix)
```

```{r analysis-preferences}
# Seed for random number generation
set.seed(42)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
pos_levels <- c("Supine", "Prone", "Sitting", "Upright", "Held")
pal <-  c("#E69F00","#56B4E9", "#009E73","#F0E442", "#0072B2") %>% 
  set_names(pos_levels)

theme_update(text = element_text(size = 14),
             axis.text.x = element_text(size = 14, color = "black"), 
             axis.title.x = element_text(size = 16),
             axis.text.y = element_text(size = 14,  color = "black"), 
             axis.title.y = element_text(size = 16), 
             panel.background = element_blank(),panel.border = element_blank(), 
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(), axis.line = element_blank(), 
             legend.key = element_rect(fill = "white")) 

```

From moment to moment, infants' movements facilitate and constrain how they can interact with their surroundings. Changes in *body position*---whether infants are supine on their backs, prone on their bellies, sitting, upright, or held by a  caregiver---have immediate consequences for vision, object exploration, and social interaction. When sitting and upright, infants have a better view of faces and distant objects compared to their view while in a prone position [@Freeplay; @LuoFranchak2020; @CWW]. Infants struggle to manipulate objects while supine and prone, but sitting affords object exploration [@SoskaAdolph2014]. Upright walking changes how infants and caregivers interact compared with crawling in a prone position; while walking infants move farther away, share toys in different ways, and hear different language from caregivers [@ChenSchneider2022; @Karasik2011; @WestIverson2021; @Karasik2014]. As infants grow older and acquire new abilities, such as independent sitting and walking, the spend more time sitting and upright and less time held, supine, and prone [@Survey; @Thurman2017; @Freeplay; @AdolphCTL2014]. Thus, characterizing individual differences in the day-to-day accumulation of body position experiences informs developmental theory by revealing differential opportunities for learning [@CurrentOpinion].
<!-- Other west cites; cite new EMA; KretchKoziol2022 -->

In this paper, we present an inertial sensing method to classify infant body position from moment-to-moment across an entire day, and validate its accuracy using over 100 hours of video recorded across 35 in-home data collection sessions. Our method takes inspiration from a more mature technology: Long-form audio recordings of infants' language experiences using wearable audio recorders. We begin by describing the impact of long-form audio recordings on research in developmental psychology, and identify the key features that should be replicated in long-form recordings of motor behavior. Next, we review the current state-of-the-art in measuring infant motor behavior---video and survey data---and their limitations in capturing real-time, full-day behavior. Finally, we discuss the advantages of using inertial sensing to classify motor behavior. Despite promising past results in brief, supervised sessions [@FranchakScott2021; @AiraksinenRasanen2020; @AiraksinenGallen2022], the current investigation takes a needed step forward by testing accuracy over long, unsupervised recordings. Although in the current investigation we focus on classification of body position, this approach can be extended to categorize other aspects of movement, such as locomotion [@AiraksinenRasanen2020] and infant-caregiver contact [@YaoPlotz2019]. Accompanying our paper, we have created a database [CITE] containing synchronized video and IMU data, allowing researchers to annotate and train models for behaviors beyond body position. 

## Inspiration from Long-Form Audio Methods

The LENA&reg; recorder is a commercial device that is worn by infants in a custom shirt pocket that has sufficient battery life and storage to record for an entire day. Closed-source LENA&reg; algorithms analyze the audio recordings to provide automatic counts of useful metrics, such as the number of words spoken by adults in the vicinity of the participant. Other long-form audio methods rely on custom-built recorders [@WassPhillips2022], apply alternative classification algorithms to LENA&reg; data [@RasanenSeshadri2020; @MichelettiYao2022], or manually transcribe audio recorded by LENA&reg; devices to improve accuracy or identify behaviors beyond the built-in categories [@Bergelson2019Corpus; @MendozaFausey2021].

Long-form audio recordings have had a transformational impact on language development research by allowing researchers to characterize opportunities for learning in daily life. Measuring the amount of speech heard by infants in the home [@Weisleder2013] or in a daycare setting [@PerryPrince2018] revealed individual differences input that predict later vocabulary. Full-day language recording synchronized with other data sources allows researchers to identify how auditory input and vocal production interact with other processes. Beyond individual differences in aggregated data, long-form recordings can be used to determine the temporal schedule of experiences. For example, infants' daily experiences hearing music are clustered in time, with "bursty" episodes of hearing music separated by relatively long periods during which music is absent [@MendozaFausey2022]. Synchronizing audio recordings with other data sources extends researchers' ability to characterize daily experiences. Linking LENA&reg; speech measurements to repeated, time-stamped text-message surveys about infant device placement revealed that infants heard less caregiver speech during moments that they were restrained in devices such as swings, exersaucers, and car seats [@MalachowskiSalo2023]. A custom-built wearable ECG and audio recorder allowed @WassPhillips2022 to discover that infant arousal increases the likelihood of infant vocalization across the day. 

We identified five key features of long-form audio methods that should be replicated in analogous studies of motor behavior. First, wearable audio recorders are *mobile*. Measurement is not limited to a particular room because the recording device travels with the participant. Data are recorded to onboard device memory, so participants do not need to be in range of a receiver. Second, wearable audio recording is *unobtrusive*. Participants' reactivity to observation, such as from a video camera, may influence behavior. For example, caregivers spoke more frequently to infants during a video-recorded portion of a home recording compared with audio-only segments captured by a LENA&reg; device [@Bergelson2019Input]. Third and fourth, recordings capture *real-time data* over a *full day*. The ability to record real-time data is vital for making inferences about processes that happen on the timescale of minutes or even seconds within in an individual as opposed to comparisons of aggregated data between infants. Synchronizing real-time data to other data streams helps to reveal sources of variability within an individual [e.g., @WassPhillips2022]. Full-day recordings are essential for capturing experiences across the heterogeniety of daily routines that moderate behavior (e.g., play, feeding, errands) [@KadookaCaufield2021]. "Burstiness" of behavior means that long recordings are needed to capture clusters of events amid long periods in which they may be absent [@BarbaroFausey2022; @WarlaumontSobowale2021]. Fifth, *automatic classification* means that the approach can scale to analyze large numbers of participants over long recordings without the bottleneck of manual annotation/transcription. Automatic classification can only replace human annotation if it is sufficiently accurate and unbiased. An independent assessment of the LENA&reg; algorithms found mixed results about the accuracy of different outcomes. For example, correlations between human transcribed counts of adult words and child vocalizations against LENA&reg;'s automatic counts were strong, *r* = .698 and *r* = .649, respectively [@CristiaLavechin2020]. However, poor agreement was found for other metrics, such as the number of "conversational turns" between the child and communicative partners and the identification of male speakers. 
<!-- EVENTUALLY CITE EMA HERE -->

Thus, for some use cases (and for some metrics), long form audio recordings provide a mobile, unobtrusive way to automatically score real-time data over a full day. In the remainder of the paper, we turn to the question of how to replicate these qualities in long form recordings of motor behavior.

## Limitations of Video and Survey Methods

Video and survey methods are the current state-of-the-art in assessing motor behavior. Although, each method has  advantages and disadvantages for characterizing infants' everyday motor experiences that complements the other, neither method on its own can provide comparable data to the long form audio recordings reviewed in the previous section.

Video observation is the most common way of measuring infant motor behavior in home recordings. Most often, an experimenter with a handheld camera follows infants from room to room to ensure that their movements are visible throughout the recording session [@Karasik2011; @ChenSchneider2022; @HerzbergFletcher2021]. The primary advantage of video recording is that it captures real-time behavior. Infants' body position, locomotion, and reaching comprise events that occur on the timescale of seconds, so standard video recording is adequate to score gross motor behavior. However, requiring an experimenter to operate a camera is obtrusive, whereas relying on a stationary camera means that infants will be absent from view as they move from place to place. Moreover, video observation cannot easily scale to long durations or large numbers of participants. Logistically, an experimenter cannot follow behind infants to record their behavior from morning to night (and were they to do so, they would likely alter infants' and caregivers' behavior). Typical video recording sessions last 45-120 minutes [@Karasik2011; @ChenSchneider2022; @HerzbergFletcher2021], short of capturing the variety of activities across the full daily routine. Even if full day videos were available, the lack of suitable automatic classification tools means that the human cost of annotation makes it difficult for video methods to scale to testing large numbers of participants. Our annotation of body position takes approximately 2-5 hours to complete for every hour of video (depending on how often infants switch positions), meaning that a full "waking day" of approximately 11 hours for a 12-month-old [@GallandTaylor2012] could take 22-55 hours of labor to full annotate. 

In contrast, survey methods such as daily diaries/inventories or ecological momentary assessment (EMA) are mobile, unobtrusive, can be applied across an entire day, and do not need laborious annotation. Diary studies provide caregivers with logs or structured interviews to estimate from memory how much time infants spend in particular activities [@MajnemerBarr2005; @KarasikKuchirko2022]. Ecological momentary assessment uses text-message or app-based notifications to prompt caregivers to make repeated estimates of infants' behavior over the course of a day [@Survey; @KadookaCaufield2021]. And although the responses are valuable in aggregate, survey methods lack the real-time temporal resolution to describe moment-to-moment changes in behavior. For diaries and interviews, limits on caregivers' memory mean that they will report what was most frequent, but cannot remember events that happen on the scale of seconds and minutes. At best, EMA surveys prompt caregivers to make hourly observations; increasing the number of surveys per day would be too burdensome for the respondent. Thus, despite being a useful tool for estimating broad developmental changes and individual differences in infants' motor experiences, survey methods are not suited for capturing within-participant temporal dynamics.

## Promise of Inertial Sensing Methods 

Measuring infant movement with inertial movement units (IMUs) is a promising avenue for long form recordings of motor behavior in the home. Lightweight sensors (10-30 g) can be embedded in garments to make recordings fully *mobile*, and they are *unobtrusive* because they do not require a researcher's presence nor do they record sensitive audio/video that might influence participants' behavior [(Cliff et al., 2009; de Barbaro, 2019; Lobo et al., 2019; Bruijns et al., 2020)]. Many commercially-available and inexpensive IMUs have > 12 hour battery life with onboard storage to record *real-time*, *full-day* motion data at a sampling rate that is higher than typical video (e.g., 50-100 Hz). Moreover, past work has successfully recorded the rate of leg kicks [e.g., @DengTrujillo-Priego2019] and activity intensity [@SchnellerBentsen2017] in infants and children across multiple days. 
<!-- CHECK THAT CITATIONS ARE FULL DAY -->

The open question is whether *automatic classification* is sufficiently accurate to measure movement categories that are relevant to developmental and clinical research, and whether measurement validity is acceptable over long recording periods. IMUs typically contain accelerometers that measure linear acceleration paired with gyroscopes that measure angular acceleration. Unlike motion tracking systems that might be used in a lab, IMUs do not provide data about the position of the body in space. Thus, data processing algorithms are needed to classify the raw sensor data (i.e., linear and angular acceleration timeseries) into meaningful categories (e.g., supine, prone, sitting, upright). The difficulty of the classification task depends on the categories of interest. More basic aspects of movement, such as overall activity intensity, can be identified by taking the magnitude of acceleration (irrespective of direction) and applying thresholds or cut-points to define when a movement has occurred at a particular intensity [(Trost et al., 2012; Kuzik et al., 2015; Hager et al., 2017; Armstrong et al., 2019)]. 

Categorizing body position---supine on the back, prone on the belly, sitting, upright, or held off the ground by a caregiver---is too complex for cut-point definitions to be accurate. First, the magnitude of movement can vary greatly *within* a body position. An upright infant can be standing still or can be walking briskly across the room. A prone infant and be stationary in "tummy time" or crawling in myriad ways [ADOLPH]. Moreover, the configuration of the arms, legs, and torso within a body position can vary greatly in everyday contexts. Infants can sit on the floor in a tripod position with support from an arm, in a "V" position with legs fully extended, in a "W" position with knees bent. Sitting on a caregivers' lap without the need to maintain balance means that the legs can dangle and the torso can lean in different directions. Sitting in a high chair or car seat reduces the magnitude of postural sway within sitting, and creates even more possibilities for how the arms and legs may move relative to the torso. Indeed, creating an all-encompassing set of rules for how to annotate sitting from video is no trivial task because of the various ways that sitting can occur in daily life. Finally, caregivers frequently pick up and transport infants, creating motion signals that need to be differentiated from independent activity [@KwonZavos2019; @PatelShi2019]. Thus, modern approaches to human activity recognition have used machine learning to classify activity categories based on features derived from IMU data in adults [(Preece et al., 2009; Arif and Kattan, 2015)], children [(Nam and Park, 2013; Zhao et al., 2013; Ren et al., 2016; Stewart et al., 2018)], and infants [Franchak; Airaksinen; Yao]. Synchronized video with ground-truth human annotations creates training data for a machine learning algorithm, such as a random forest model, that can be later used to predict categories from IMU data that was not annotated. Crucially, this allows automatic classification to scale to full day recording by relying on a relatively smaller set of video annotation. 
GREENSPAN...

Three prior investigations have used machine learning to categorize infant body position from IMUs towards the goal of collecting full-day data. @AiraksinenRasanen2020 tested 4- to 8-month-olds in a laboratory visit, and found XX% accuracy (kappa = XX%) in distinguishing between body position categories that crawling infants could perform on the floor (excluding times that infants were held by caregivers). Using a wider age range of XX-XX, [FRANCHAK] found XX% accuracy (kappa = XX%) in a laboratory validation study in categorizing body position that included infants who could both crawl and walk and also categorized caregiver holding. Most recently, [Airaksinen NEW] conducted a validation study of body position classification in either a home or clinic testing in 4- to 19-month-olds, refining their previous method to detect moments that infants were carried by caregivers. Classification accuracy did not vary between lab and home settings, and was generally high (95%, kappa = .93). Although all three studies yielded promising classification accuracy, accuracy was assessed in brief (15-60 minute) sessions supervised by a researcher, leaving the open question of how well body position classification will scale to testing across an entire day of natural home life. 
YAO?

## Goals of the Current Study

Accordingly, the overarching goal of the current study is to test the feasibility and validity of long-form body position recording in the home during unsupervised, everyday behavior. Supervised recordings from past work [CITES], whether in the home or in the lab, let researchers set up the situation to encourage or restrict certain behaviors. Usually, caregivers are asked to play with the infant. However, across a real day, non-play activities (e.g., eating lunch in a high chair) create challenging situations for applying automated classification of body position. Will models trained on video-recorded observations at the beginning of the day generalize to predict behavior at a later time? Assessing the validity of temporally *distal* periods is a crucial step to establish whether automatic classification can be used to measure body position across a day. 

In the current study, we report the feasibility and validity of body position classification over the full day in the home based on 35 testing sessions from XX infants aged 4-14 months. Participants received a custom pair of infant leggings embedded with 4 IMUs (one on each ankle and one on each hip) and a video camera to collect ground truth data about infant body position. A *proximal comparison* period began when participants received the equipment and completed a guided phone call during which caregivers were asked to elicit different body positions based on prompts from the experimenter. Although not directly supervised, this period was most similar to previous recordings because it occurred during a convenient time for the infant and caregiver to play while they received instructions from the experimenter. The **first goal** of the current study was to determine the accuracy of body position classification during the proximal comparison period using this novel, semi-supervised procedure in participants' homes. 

A second, *distal comparison* period followed the proximal comparison period and captured approximately 90 minutes of home behavior that was completely unsupervised. Caregivers and infants could (and did) do whatever they wished. Because this recording happened a considerable amount of time after the initial setup and instructions from the experimenter, accuracy could decline if caregivers or infants moved the garment or sensors. Moreover, increasing variation in everyday activities during the distal comparison creates a greater challenge for classification, testing whether machine learning models can generalize to novel test cases. Thus, the **second goal** of our study was to assess accuracy during the distal comparison. 

After this second video recording period, we asked caregivers to keep infants wearing IMUs for the rest of the day until their regular bedtime, creating the **first real-time, full-day dataset of infant body position**. Interpreting such data required caregivers to log when infants napped, when they removed the sensor garment for diaper changes or other reasons, and when infants went to bed at the end of the day. The **third goal** of the study was to examine the quality of the full-day data. Could body position be successfully recorded over the desired period? Finally, the novel full-day dataset affords us a unique chance to ask whether the estimated time infants spent in different body positions align with past results using video and survey methods. Thus, the **fourth goal** of the current study was to determine whether full-day body position measurements conformed to expectations about age differences in body position. Based on past results [CITE], infants should spend increasingly more time sitting and upright but less time supine over the age range tested (4 to 14 months). 

# Methods

## Participants

## Apparatus

## Procedure

```{r exemplartimeline, out.width="0.99\\linewidth", include=TRUE, fig.align="center", fig.cap="Example Timeline Caption.", echo=FALSE}
knitr::include_graphics("figures/timeline.png")
# Generated from analysis-pt2/methods-exemplar-agreement.R
# Annotated in illustrator based on event times:
# Exemplar participant is 120-1
# > pt2_start_time = "2022-11-13 11:11:00 PST"
# > pt2_end_time = "2022-11-13 12:41:01 PST"
# > session_param$start_time_coded = "2022-11-13 10:02:40 PST"
```

## Body position annotation

## Body position classification

# Results

## Goal 1: Assess the proximal accuracy of body position classification models

<!-- group_split_metrics, generated from group_split_comparison in this proj, stable copy in data/ -->

```{r metrics, warning=FALSE, fig.cap="Metrics", fig.align="center", fig.width=5, fig.height=8}
metrics <- read_csv("data/group_split_metrics.csv") %>% 
  filter(model %in% c("group", "split")) %>% 
  mutate(Model = factor(model, levels = c("group", "split"), labels = c("Group", "Individual")))

metrics_long <- metrics %>% pivot_longer(cols = `Overall Accuracy`:Kappa, 
                                         names_to = "metric",
                                         values_to = "value")

metric_plot <- function(ds, met) {
  ds %>% filter(metric == met) %>% 
    ggplot(aes(x = Model, y = value)) + 
    geom_sina(alpha = .7, fill = "turquoise3", size = 4, maxwidth = .5, shape = 21) +
    stat_summary(fun = "mean", mapping = aes(x = Model, y = value), shape = "-", fill = "black", size = 4) + 
    ylim(0, 1) + ylab(met) + xlab("") + 
    theme(plot.title.position = "plot",
          axis.title.y = element_text(size = 13),
          axis.text.y = element_text(size = 11),
          axis.text.x = element_text(size = 13))
}
metric_labels <- c("Overall Accuracy", "Balanced Accuracy", "F1", "Sensitivity", "Pos Pred Value", "Kappa")
title_labels <- c("A. Overall Accuracy", "B. Balanced Accuracy", "C. F1 Score", "D. Sensitivity", "E. Pos. Pred. Value", "F. Kappa")
metric_plots <- map(metric_labels, ~ metric_plot(metrics_long, .x)) %>% map2(., title_labels, ~.x + ggtitle(.y))
(metric_plots[[1]] + metric_plots[[2]])/(metric_plots[[3]]+metric_plots[[4]])/(metric_plots[[5]] + metric_plots[[6]])

#Worst three Kappa individuals are 9, 111-4, and 120-2
#Worst three Kappa groups are 9, 110-4
#Worst three Overall Accuracy (grouped) are 104-1, 106-1, 108-2 (first two are pt 2 outliers)

```

```{r metricstable}

metrics_long %>% group_by(Model, metric) %>% 
  get_summary_stats(value) %>% 
  select(-(variable:max), -(q1:mad), -se, -ci) %>% 
  pivot_wider(names_from = Model, values_from = c("median", "mean", "sd")) %>% 
  filter(metric != "Neg Pred Value", metric != "Specificity") %>% 
  relocate(mean_Group, .after = median_Group) %>% 
  relocate(sd_Group, .after = mean_Group) %>% 
  mutate(across(-metric, ~ apa_num(.x, digits = 3)),
         metric = factor(metric, levels = metric_labels)) %>% 
  arrange(metric) %>% 
  apa_table(., col.names = c("Metric", "Median", "Mean", "SD", "Median", "Mean", "SD"),    col_spanners = list("Group" = c(2, 4), "Individual" = c(5, 7)),
          caption = "Summary statistics for model performance metrics shown separately for group and individual models.")
```

\renewcommand{\arraystretch}{.75}

```{r metricsbyclass}
metrics_class <- read_csv("data/group_split_metrics_class.csv") %>% 
  filter(model %in% c("group", "split")) %>% 
  mutate(Model = factor(model, levels = c("group", "split"), labels = c("Group", "Individual")))

metrics_long_class <- metrics_class %>% pivot_longer(cols = `Balanced Accuracy`:Kappa, 
                                         names_to = "metric",
                                         values_to = "value")

metrics_long_summary <- metrics_long_class %>% group_by(Class,Model, metric) %>% 
  get_summary_stats(value) %>% 
  select(-(variable:max), -(q1:mad), -se, -ci) %>% 
  pivot_wider(names_from = Model, values_from = c("median", "mean", "sd")) %>% 
  filter(metric != "Neg Pred Value", metric != "Specificity") %>% 
  relocate(mean_Group, .after = median_Group) %>% 
  relocate(sd_Group, .after = mean_Group) %>% 
  mutate(across(-(Class:metric), ~ apa_num(.x, digits = 3)),
         metric = factor(metric, levels = metric_labels),
         Class = factor(Class, levels = c("Supine", "Prone", "Sitting", "Upright", "Held"))) %>% 
  relocate(metric, .before = Class) %>% 
  arrange(metric, Class) 

class_table <- metrics_long_summary %>% mutate(metric = as.character(metric))
class_table$metric[duplicated(class_table$metric)] <- " "

apa_table(class_table, col.names = c("Metric","Position", "Median", "Mean", "SD", "Median", "Mean", "SD"), col_spanners = list("Group" = c(3, 5), "Individual" = c(6, 8)),
          midrules = c(5, 10, 15, 20),
          caption = "Model performance metrics for each body position category, shown separately for group and individual models.")
```

## Goal 2: Assess the distal accuracy of body position classification models

<!-- compiled_agreement, generated from analysis-part2 -->

```{r part2overall, warning=FALSE, fig.cap="Overall agreement between human-coded body position and model-predicted body position in the distal comparison. Agreement for group models is shown in (A) and agreement for individual models is shown in (B). Plots are shown separately for each body position with a reference line that indicates perfect agreement; each point in a plot represent data for a single participant. The three outlier participants are plotted in dark gray, with a different shape marking each individual.", fig.align="center", fig.width=7, fig.height=6.5}

# PART 2 AGREEMENT
pt2_group <- read_csv("data/compiled_agreement_position.csv") %>% 
  filter(nap_period == 0 & exclude_period == 0 & !is.na(code) & !is.na(pos)) %>% 
         mutate(pos = factor(pos, levels = pos_levels))
pt2_split <- read_csv("data/compiled_agreement_split.csv") %>% 
  filter(nap_period == 0 & exclude_period == 0 & !is.na(code) & !is.na(pos)) %>% 
         mutate(pos = factor(pos, levels = pos_levels))

outlier_files <- c("107/3", "104/1", "106/1")
filter_outliers <- . %>% filter(!(file %in% outlier_files))

# Count up position totals and join into an agreement data frame
calculate_agreement <- function(ds) {
  model <- ds %>% count(file, pos) %>% 
    add_count(file, wt = n, name = "total") %>% 
    mutate(prop_model = n/total)
  human <- ds %>% count(file, code) %>% 
    add_count(file, wt = n, name = "total") %>% 
    mutate(prop_human = n/total)
  agree_group <- full_join(select(model, file, pos, prop_model), 
                     select(human, file, code, prop_human), 
                     by = c("file" = "file", "pos" = "code"))
  agree_group <- agree_group %>% mutate(prop_human = ifelse(is.na(prop_human), 0, prop_human),
                            prop_model = ifelse(is.na(prop_model), 0, prop_model))
  agree_group <- complete(agree_group, file, pos, fill = list(prop_human = 0, prop_model = 0))
}

agree <- map(list("group" = pt2_group, "split" = pt2_split), calculate_agreement)

agreement_scatter <- function(ds) {
  ggplot() +
  geom_point(data = filter(ds, file %in% outlier_files), mapping = aes(x = prop_human, y = prop_model, shape = file, fill = pos), fill = "#333333", size = 4, alpha = .5) + 
  geom_point(data = filter_outliers(ds), mapping = aes(x = prop_human, y = prop_model, fill = pos), shape = 21, alpha = .5, size = 4) + 
  geom_abline(intercept = 0, slope = 1) + 
  scale_fill_manual(values = pal, guide = "none") + 
  scale_shape_manual(guide = "none", values = 22:24) + 
  scale_x_continuous(breaks = c(0,.5,1), labels = c(0, 50, 100), limits = c(-.07, 1.07), name = "Actual Prevalence (%)") + 
  scale_y_continuous(breaks = c(0,.5,1), labels = c(0, 50, 100), limits = c(-.07, 1.07), name = "Predicted Prevalence (%)") + 
  facet_wrap("pos", ncol = 2, as.table = F) +
  theme(panel.spacing.x = unit(1, "lines")) +
  theme(panel.spacing.y = unit(1, "lines")) + 
  theme(strip.background = element_blank(), strip.text.x = element_text(size = 16, face = "bold"))
}

agree_plots <- map(agree, agreement_scatter)
agree_plots <- map2(agree_plots, c("A. Group Models", "B. Individual Models"), ~ .x + ggtitle(.y))
agree_plots[[1]] + agree_plots[[2]]
```

```{r, pt2overalltable}
#By posture
pt2corr_with_outliers <- map_dfc(agree, ~ .x %>% group_by(pos) %>% cor_test(vars = c("prop_model", "prop_human")) %>% select(pos, cor)) %>% select(-`pos...3`)
pt2corr_without_outliers <- map_dfc(agree, ~ .x %>% filter_outliers %>% group_by(pos) %>% cor_test(vars = c("prop_model", "prop_human")) %>% select(pos, cor)) %>% select(-`pos...1`,-`pos...3`)
pt2corr <- bind_cols(pt2corr_with_outliers, pt2corr_without_outliers)
rm(pt2corr_with_outliers)
rm(pt2corr_without_outliers)

#Overall
group_agree_cor <- cor_test(agree$group, vars = c("prop_model", "prop_human")) %>% pull(cor)
split_agree_cor <- cor_test(agree$split, vars = c("prop_model", "prop_human")) %>% pull(cor)
group_agree_cor_noout <- agree$group %>% filter_outliers %>% 
  cor_test(vars = c("prop_model", "prop_human")) %>% pull(cor)
split_agree_cor_noout <- agree$split %>% filter_outliers %>%
  cor_test(vars = c("prop_model", "prop_human")) %>% pull(cor)
overall_row <- tibble("Overall", group_agree_cor, split_agree_cor, group_agree_cor_noout, split_agree_cor_noout)
colnames(overall_row) <- colnames(pt2corr)
pt2corr <- bind_rows(pt2corr, overall_row)
apa_table(pt2corr, col.names = c("Position", "Group", "Individual", "Group", "Individual"), col_spanners = list(`With Outliers` = c(2, 3), `Without Outliers` = c(4, 5)),
          midrules = 5, caption = "Correlations between human-coded and model-predicted body position durations across the entire long delay period. Correlations are provided within each posture and overall, and computed separately using group and individual models with and without outlier participants.")
```

```{r part2bins, warning=FALSE, fig.cap="Prediction performance (difference in minutes between human-coded and model-predicted body position) for 10-minute bins in the distal comparison. Each point shows the mean and SE for a single participant for each body position, summarizing the prediction difference for each of their 10-minute bins. Points falling within the gray shaded region indicate that average prediction errors were less than 1 minute. Performance is plotted separately for (A) group models and (B) individual models. The three outlier participants are plotted in dark gray, with a different shape marking each individual.", fig.align="center", fig.width=8, fig.height=4.5}
calculate_agreement_bins <- function(ds) {
  ds <- ds %>% group_by(file) %>% 
    mutate(sample = row_number(), bin = floor(sample/300)) %>% 
    add_count(file, bin) %>% ungroup() %>% filter(n > 200) %>% group_by(file) %>% mutate(num_bins = length(unique(bin))) %>% ungroup()
  model <- ds %>% count(file, bin, num_bins, pos) %>% add_count(file, bin,num_bins,  wt = n, name = "total") %>% mutate(prop_model = n/total)
  human <- ds %>% count(file, bin, num_bins,  code) %>% add_count(file, bin, num_bins, wt = n, name = "total") %>% mutate(prop_human = n/total)
  agree <- full_join(select(model, file, pos, prop_model, bin, num_bins), 
                     select(human, file, code, prop_human, bin, num_bins), 
                     by = c("file" = "file", "pos" = "code", "bin" = "bin", "num_bins" = "num_bins"))
  agree <- agree %>% mutate(prop_human = ifelse(is.na(prop_human), 0, prop_human),
                            prop_model = ifelse(is.na(prop_model), 0, prop_model),
                            pos - factor(pos, levels = pos_levels))
  agree <- complete(agree, nesting(file, bin, num_bins), pos, fill = list(prop_human = 0, prop_model = 0))
}

agree_bins <- map(list("group" = pt2_group, "split" = pt2_split), calculate_agreement_bins)

difference_plot <- function(ds) {
  ds <- mutate(ds, diff = prop_human - prop_model)
  ggplot(filter_outliers(ds), aes(x = pos, y = diff, fill = pos, group = file)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -.1, ymax = .1, fill = "gray", color = "gray") + 
  #geom_rect(aes(xmin = "Held", xmax = "Upright",ymin = -.1, ymax = .1), fill = "#e5e5e5", color = "#e5e5e5") + 
  stat_summary(data = filter(ds, file %in% outlier_files), position = position_dodge(.4), aes(shape = file), fill = "#333333", size = .75, stroke = .25) +
  stat_summary(position = position_dodge(.4), shape = 21, size = .75, stroke = .25) +
  scale_fill_manual(values = pal, guide = "none") +
  scale_shape_manual(guide = "none", values = 22:24) + 
  coord_cartesian(ylim = c(-1, 1)) + xlab("") + 
  scale_y_continuous(name = "Prediction Difference (min)", breaks = seq(-1, 1, .2), labels = seq(-10, 10, 2), minor_breaks = waiver()) + 
    theme(axis.text.x = element_text(size = 13, color = "black"))
}
difference_plots <- map(agree_bins, ~ difference_plot(.x))
difference_plots <- map2(difference_plots, c("A. Group Models", "B. Individual Models"), ~ .x + ggtitle(.y))
difference_plots[[1]] + difference_plots[[2]]
```

```{r pt2binstable}
#Bins
pt2corr_with_outliers <- map_dfc(agree_bins, ~ .x %>% group_by(pos) %>% cor_test(vars = c("prop_model", "prop_human")) %>% select(pos, cor)) %>% select(-`pos...3`)
pt2corr_without_outliers <- map_dfc(agree_bins, ~ .x %>% filter_outliers %>% group_by(pos) %>% cor_test(vars = c("prop_model", "prop_human")) %>% select(pos, cor)) %>% select(-`pos...1`,-`pos...3`)
pt2corr_bins <- bind_cols(pt2corr_with_outliers, pt2corr_without_outliers)
rm(pt2corr_with_outliers)
rm(pt2corr_without_outliers)

group_agree_cor <- cor_test(agree_bins$group, vars = c("prop_model", "prop_human")) %>% pull(cor)
split_agree_cor <- cor_test(agree_bins$split, vars = c("prop_model", "prop_human")) %>% pull(cor)
group_agree_cor_noout <- agree_bins$group %>% filter_outliers %>% 
  cor_test(vars = c("prop_model", "prop_human")) %>% pull(cor)
split_agree_cor_noout <- agree_bins$split %>% filter_outliers %>%
  cor_test(vars = c("prop_model", "prop_human")) %>% pull(cor)
overall_row <- tibble("Overall", group_agree_cor, split_agree_cor, group_agree_cor_noout, split_agree_cor_noout)
colnames(overall_row) <- colnames(pt2corr_bins)
pt2corr_bins <- bind_rows(pt2corr_bins, overall_row)
rm(overall_row)
apa_table(pt2corr_bins, col.names = c("Position", "Group", "Individual", "Group", "Individual"), col_spanners = list(`With Outliers` = c(2, 3), `Without Outliers` = c(4, 5)),
          midrules = 5, caption = "Correlations between human-coded and model-predicted body position durations using 10-minute bins during the distal comparison. Correlations are provided within each posture and overall, and computed separately using group and individual models with and without outlier participants.")
```

## Goal 3: Examine the data quality of full-day home recordings

<!-- imu-compiled.csv, generated from analysis-lena-imu/compile_lena_imu.R -->

```{r timelines, warning=FALSE, fig.cap="Timelines", fig.align="center", fig.width=7.75, fig.height=8}
timeline_data <- read_csv("data/imu-compiled.csv") %>% 
  mutate(id_uni = factor(id*100+session),
         group = factor(ifelse(age <= 8, "Younger", "Older")),
         nap_time = ifelse(is.na(sit_time), nap_time, NA)) %>% 
  pivot_longer(cols = nap_time:upright_time, names_to = "position", values_to = "prop") %>% 
  mutate(Position = factor(position,
                           levels = c("nap_time","upright_time", "sit_time", "prone_time", "supine_time", "held_time"),
                           labels = c("Nap","Upright", "Sitting", "Prone", "Supine", "Held"))) %>% 
  arrange(Position, age)

timelines <- function(ds) {
  lims <- as_hms(c('09:00:00', '21:59:00'))
  hour_breaks = as_hms(c('09:00:00', '10:00:00', '11:00:00', '12:00:00', '13:00:00', '14:00:00', '15:00:00', '16:00:00', '17:00:00', '18:00:00', '19:00:00', '20:00:00', '21:00:00'))
  label_breaks = c("9am","","11am","","1pm","","3pm","","5pm","","7pm","","9pm")
  ggplot(ds, aes(x = clock_time_start, y = prop, fill = Position)) + 
  geom_bar(stat = "identity") + 
  facet_wrap("id_uni",ncol = 1, strip.position = "left") + 
  scale_fill_manual(values = c("Nap" = "gray",pal), name = "") + 
  scale_x_time(breaks = hour_breaks, labels = label_breaks, name = "", limits = lims) + 
  theme(legend.position = "bottom", 
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        strip.background = element_blank(),
        axis.text.x = element_text(size = 11),
        strip.text.y = element_blank()) + ylab("")
  #https://ggplot2tor.com/scales/scale_x_time for options
}

timeline_plots <- map(c("Younger", "Older"), ~ timelines(filter(timeline_data, group == .x)))
timeline_plots <- map2(timeline_plots, c("A. 4-7 Months", "B. 11-14 Months"), ~ .x + ggtitle(.y))
timeline_plots[[1]] + timeline_plots[[2]]
```

## Goal 4: Assess the suitability of full-day predictions for capturing age differences in body position

<!-- imu-compiled.csv, generated from analysis-lena-imu/compile_lena_imu.R -->

```{r age, warning=FALSE, fig.cap="Age trends", fig.align="center", fig.width=7.5, fig.height=7}
fullday_group <- read_csv("data/imu-compiled.csv") %>% 
  mutate(id_uni = factor(id*100+session),
         group = factor(ifelse(age <= 8, "Younger", "Older")),
         nap_time = ifelse(is.na(sit_time), nap_time, NA))
fullday_split <- read_csv("data/imu-compiled-split.csv") %>% 
  mutate(id_uni = factor(id*100+session),
         group = factor(ifelse(age <= 8, "Younger", "Older")),
         nap_time = ifelse(is.na(sit_time), nap_time, NA))
fullday <- list("group" = fullday_group, "split" = fullday_split)

fullday_long <- function(ds) {
  ds %>% pivot_longer(cols = sit_time:upright_time, names_to = "position", values_to = "prop") %>% 
  mutate(position = factor(position,
                           levels = c("upright_time", "sit_time", "prone_time", "supine_time", "held_time"),
                           labels = c("Upright", "Sitting", "Prone", "Supine", "Held"))) %>% 
  arrange(position, age)
}

age_scatter <- function(ds) {
  ds %>% drop_na(prop) %>% 
  ggplot() + facet_wrap("position", as.table = T, ncol = 2) + 
  geom_smooth(aes(x = age, y = prop), color = "#191919", method = "lm", se = T) + 
  stat_summary(fun = "mean", mapping = aes(x = age, y = prop, group = id_uni, fill = position), shape = 21, size = .7) + 
  scale_fill_manual(values = pal, guide = "none") + 
  scale_x_continuous(name = "Age (months)", breaks = seq(3, 15, 3), limits = c(3,15)) + 
  ylim(0,1) + ylab("Proportion of waking day") + 
  theme(panel.spacing.x = unit(.5, "lines")) +
  theme(panel.spacing.y = unit(1, "lines")) + 
  theme(strip.background = element_blank(), strip.text.x = element_text(size = 16, face = "bold"))
}

age_plots <- map(fullday, fullday_long) %>% map(age_scatter)
age_plots <- map2(age_plots, c("A. Group Models", "B. Individual Models"), ~ .x + ggtitle(.y))
age_plots[[1]] + age_plots[[2]]

# outlier_ids <- c(10701, 10401, 10601)
# fullday %>% cor_mat(age, sit_time:upright_time) %>% cor_mark_significant()
# fullday %>% filter(!(id_uni %in% outlier_ids)) %>% cor_mat(age, sit_time:upright_time) %>% cor_mark_significant()
# 
# fullday_long %>% group_by(position, group) %>% get_summary_stats(prop)

```

```{r agetable}
pos_sum_age <- map(fullday, fullday_long) %>% 
  map(~ group_by(.x, group, position, id_uni) %>% 
            mutate(prop = prop * 100) %>% 
            get_summary_stats(prop) %>% 
            group_by(group, position) %>% 
            get_summary_stats(mean) %>% 
            select(group, position, mean, sd))
pos_sum_age <- pos_sum_age %>% map2_dfr(c("Group", "Individual"), 
                         ~ mutate(.x, Model = .y,
                                  mean_sd = str_glue("{apa_num(mean, digits = 1)}% ({apa_num(sd, digits = 1)})")) %>% 
                           select(-mean, -sd) %>% 
                           pivot_wider(names_from = group, values_from = mean_sd)) %>% 
  pivot_wider(names_from = Model, values_from = c("Younger", "Older")) %>% 
  relocate(Younger_Individual, .after = Older_Group)
apa_table(pos_sum_age, col.names = c("Position", "Younger", "Older", "Younger", "Older"), col_spanners = list("Group" = c(2, 3), "Individual" = c(4, 5)),
          caption = "Summary of age differences in full-day body position for younger (4- to 7-month) and older (11- to 14-month) infants. Values shown are the mean percent of time for each body position averaged across infants in each group. Standard deviations are shown in parentheses. Descriptive statistics are shown separately for group and individual models.")

```

# Discussion

\newpage

# References

::: {#refs custom-style="Bibliography"}
:::
