---
title             : "Full-day, in home validation of infant body position measurements from inertial sensors"
shorttitle        : "Infant position in the home"

author: 
  - name          : "John M. Franchak"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "UC Riverside Department of Psychology, 900 University Avenue, Riverside, CA 92521"
    email         : "franchak@ucr.edu"
  - name          : "Maximilian Tang"
    affiliation   : "1"
  - name          : "Hailey Rousey"
    affiliation   : "1"
  - name          : "Chuan Luo"
    affiliation   : "1"
      
authornote: |
  Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.

  Enter author note here.

abstract: |
  Abstract
  
keywords          : "body position, motor development, everyday experiences, sitting, machine learning"
wordcount         : "X"

bibliography      : "master.bib"

floatsintext      : no
linenumbers       : no
draft             : no
mask              : no
figurelist        : no
tablelist         : no
footnotelist      : no
csl               : apa.csl
classoption       : "man"
output            : papaja::apa6_pdf
header-includes:
  - \raggedbottom
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
library(papaja)
library(knitr)
library(patchwork)
library(tidyverse)
library(rstatix)
```

```{r analysis-preferences}
# Seed for random number generation
set.seed(42)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
pos_levels <- c("Supine", "Prone", "Sitting", "Upright", "Held")
pal <-  c("#E69F00","#56B4E9", "#009E73","#F0E442", "#0072B2") %>% 
  set_names(pos_levels)

theme_update(text = element_text(size = 14),
             axis.text.x = element_text(size = 14, color = "black"), 
             axis.title.x = element_text(size = 16),
             axis.text.y = element_text(size = 14,  color = "black"), 
             axis.title.y = element_text(size = 16), 
             panel.background = element_blank(),panel.border = element_blank(), 
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(), axis.line = element_blank(), 
             legend.key = element_rect(fill = "white")) 

```


# Current Study

# Methods

## Participants

## Apparatus

## Procedure

## Body position annotation

## Body position classification

# Results

## Goal 1: Optimize and validate body position classification model
<!-- group_split_metrics, generated from group_split_comparison in this proj, stable copy in data/ -->
```{r}
metrics <- read_csv("data/group_split_metrics.csv") 


```



## Goal 2: Assess classification accuracy over long recordings
<!-- compiled_agreement, generated from analysis-part2 -->
```{r}
# Count up position totals and join into an agreement data frame
calculate_agreement <- function(ds) {
  model <- ds %>% count(file, pos) %>% add_count(file, wt = n, name = "total") %>% mutate(prop_model = n/total)
  human <- ds %>% count(file, code) %>% add_count(file, wt = n, name = "total") %>% mutate(prop_human = n/total)
  agree_group <- full_join(select(model, file, pos, prop_model), 
                     select(human, file, code, prop_human), 
                     by = c("file" = "file", "pos" = "code"))
  agree_group <- agree_group %>% mutate(prop_human = ifelse(is.na(prop_human), 0, prop_human),
                            prop_model = ifelse(is.na(prop_model), 0, prop_model))
  agree_group <- complete(agree_group, file, pos, fill = list(prop_human = 0, prop_model = 0))
}

agreement_scatter <- function(ds) {
  ggplot(ds) +
  geom_point(aes(x = prop_human, y = prop_model, fill = pos), shape = 21, alpha = .5, size = 4) + 
  geom_abline(intercept = 0, slope = 1) + 
  scale_fill_manual(name = "Posture", values = pal, guide = "none") + 
  scale_x_continuous(breaks = c(0,.5,1), labels = c(0, 50, 100), limits = c(-.07, 1.07), name = "Actual Prevalence (%)") + 
  scale_y_continuous(breaks = c(0,.5,1), labels = c(0, 50, 100), limits = c(-.07, 1.07), name = "Predicted Prevalence (%)") + 
  facet_wrap("pos", ncol = 2, as.table = F) +
  theme(panel.spacing.x = unit(1, "lines")) +
  theme(panel.spacing.y = unit(1, "lines")) + 
  theme(strip.background = element_blank(), strip.text.x = element_text(size = 16, face = "bold"))
}
```

```{r part2overall, warning=FALSE, fig.cap="Overall agreement between human-coded body position and model-predicted body position in the long-delay period. Agreement for group models is shown in (A) and agreement for individual models is shown in (B). Plots are shown separately for each body position with a reference line that indicates perfect agreement; each point in a plot represent data for a single participant.", fig.align="center", fig.width=7, fig.height=6.7}
# GROUP MODEL PART 2 AGREEMENT
pt2_group <- read_csv("data/compiled_agreement_position.csv") %>% 
  filter(nap_period == 0 & exclude_period == 0 & !is.na(code) & !is.na(pos)) %>% 
         mutate(pos = factor(pos, levels = pos_levels))
pt2_split <- read_csv("data/compiled_agreement_split.csv") %>% 
  filter(nap_period == 0 & exclude_period == 0 & !is.na(code) & !is.na(pos)) %>% 
         mutate(pos = factor(pos, levels = pos_levels))

agree <- map(list("group" = pt2_group, "split" = pt2_split), calculate_agreement)

group_agree_cor <- cor_test(agree$group, vars = c("prop_model", "prop_human")) %>% pull(cor)
split_agree_cor <- cor_test(agree$split, vars = c("prop_model", "prop_human")) %>% pull(cor)

agree_plots <- map(agree, agreement_scatter)
agree_plots <- map2(agree_plots, c("A. Group Models", "B. Individual Models"), ~ .x + ggtitle(.y))

agree_plots[[1]] + agree_plots[[2]]
```


## Goal 3: Compare classification estimates to prior literature
<!-- imu-compiled.csv, generated from analysis-lena-imu/compile_lena_imu.R -->

## Goal 4: Examine wear time and compliance in full-day data collection
<!-- imu-compiled.csv, generated from analysis-lena-imu/compile_lena_imu.R -->

# Discussion


\newpage

# References

::: {#refs custom-style="Bibliography"}
:::
